<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cage Rebar Analysis</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:       #080c14;
    --bg2:      #0d1220;
    --bg3:      #111827;
    --border:   #1c2640;
    --border2:  #263050;
    --accent:   #f59e0b;
    --accent2:  #ef4444;
    --blue:     #3b82f6;
    --green:    #22c55e;
    --text:     #e2e8f0;
    --muted:    #4a5878;
    --muted2:   #6b7a9a;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* GRID BACKGROUND */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
    pointer-events: none;
    z-index: 0;
  }

  /* LAYOUT */
  .shell { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 0 24px 60px; }

  /* â”€â”€ TOP BAR â”€â”€ */
  .topbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 0 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 32px;
  }
  .logo {
    display: flex; align-items: center; gap: 12px;
  }
  .logo-icon {
    width: 38px; height: 38px;
    background: var(--accent);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .logo-text {
    font-family: 'Rajdhani', sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #fff;
  }
  .logo-text span { color: var(--accent); }
  .topbar-badge {
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted2);
    border: 1px solid var(--border2);
    border-radius: 20px;
    padding: 4px 12px;
  }

  /* â”€â”€ UPLOAD ZONE â”€â”€ */
  #upload-zone {
    margin: 60px auto;
    max-width: 560px;
    border: 2px dashed var(--border2);
    border-radius: 16px;
    padding: 60px 40px;
    text-align: center;
    background: var(--bg2);
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
  }
  #upload-zone:hover, #upload-zone.drag { border-color: var(--accent); background: #0f1828; }
  #upload-zone .upload-icon { font-size: 3rem; margin-bottom: 16px; }
  #upload-zone h2 {
    font-family: 'Rajdhani', sans-serif;
    font-size: 1.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: #fff; margin-bottom: 8px;
  }
  #upload-zone p { color: var(--muted2); line-height: 1.6; }
  #upload-zone .formats {
    display: inline-flex; gap: 8px; margin-top: 20px;
  }
  #upload-zone .fmt {
    font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; padding: 4px 10px;
    border-radius: 4px; border: 1px solid var(--border2); color: var(--muted2);
  }
  #file-input { display: none; }

  /* â”€â”€ PROGRESS â”€â”€ */
  #progress-bar {
    display: none;
    width: 100%; height: 3px;
    background: var(--border);
    border-radius: 2px;
    margin: 8px 0 0;
    overflow: hidden;
  }
  #progress-bar .bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    animation: progress-anim 2s ease-in-out infinite;
  }
  @keyframes progress-anim {
    0%   { width: 0%; margin-left: 0; }
    50%  { width: 70%; margin-left: 0; }
    100% { width: 0%; margin-left: 100%; }
  }
  #status-msg { text-align: center; color: var(--muted2); font-size: 0.85rem; margin: 12px 0; min-height: 20px; }

  /* â”€â”€ MAIN DASHBOARD â”€â”€ */
  #dashboard { display: none; }

  /* file info strip */
  .file-strip {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 16px; margin-bottom: 24px;
    flex-wrap: wrap; gap: 8px;
  }
  .file-strip .fname { font-weight: 500; color: var(--accent); }
  .file-strip .fmeta { color: var(--muted2); font-size: 0.82rem; }
  .file-strip button {
    background: none; border: 1px solid var(--border2); border-radius: 6px;
    color: var(--muted2); padding: 4px 12px; cursor: pointer; font-size: 0.8rem;
    font-family: 'DM Sans', sans-serif; transition: all 0.15s;
  }
  .file-strip button:hover { border-color: var(--accent2); color: var(--accent2); }

  /* â”€â”€ KPI GRID â”€â”€ */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 28px;
  }
  .kpi {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: transform 0.15s, border-color 0.15s;
  }
  .kpi:hover { transform: translateY(-2px); border-color: var(--border2); }
  .kpi::after {
    content: ''; position: absolute;
    bottom: 0; left: 0; right: 0; height: 2px;
  }
  .kpi.amber::after { background: var(--accent); }
  .kpi.blue::after  { background: var(--blue); }
  .kpi.green::after { background: var(--green); }
  .kpi.red::after   { background: var(--accent2); }
  .kpi.purple::after{ background: #a855f7; }
  .kpi.cyan::after  { background: #06b6d4; }
  .kpi-label {
    font-size: 0.68rem; font-weight: 600;
    letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 10px;
  }
  .kpi-val {
    font-family: 'Rajdhani', sans-serif;
    font-size: 2rem; font-weight: 700;
    color: #fff; line-height: 1;
  }
  .kpi-sub { font-size: 0.74rem; color: var(--muted); margin-top: 6px; }

  /* â”€â”€ TABS â”€â”€ */
  .tab-bar {
    display: flex; gap: 4px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px; padding: 4px;
    margin-bottom: 20px; width: fit-content;
  }
  .tab-btn {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.85rem; font-weight: 600;
    letter-spacing: 0.08em; text-transform: uppercase;
    background: none; border: none; color: var(--muted2);
    padding: 8px 20px; border-radius: 7px;
    cursor: pointer; transition: all 0.15s;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { background: var(--accent); color: #000; }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* â”€â”€ SECTION TITLE â”€â”€ */
  .sec {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.8rem; font-weight: 700;
    letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--accent); margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ CHART GRID â”€â”€ */
  .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  @media(max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }
  .chart-box {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 10px; padding: 20px;
  }
  .chart-box canvas { max-height: 280px; }
  .chart-box-full {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 10px; padding: 20px; margin-bottom: 20px;
  }
  .chart-box-full canvas { max-height: 260px; }

  /* â”€â”€ TABLE â”€â”€ */
  .table-wrap {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden; margin-bottom: 16px;
  }
  .table-controls {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 16px; border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .search-box {
    background: var(--bg3); border: 1px solid var(--border2);
    border-radius: 6px; color: var(--text);
    padding: 7px 12px; font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem; flex: 1; min-width: 180px;
    outline: none; transition: border-color 0.15s;
  }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--muted); }
  .row-count { color: var(--muted2); font-size: 0.8rem; margin-left: auto; }
  .tbl-scroll { overflow-x: auto; max-height: 480px; overflow-y: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  thead th {
    background: var(--bg3);
    color: var(--muted2);
    font-size: 0.68rem; font-weight: 600;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 10px 14px; text-align: left;
    position: sticky; top: 0; z-index: 2;
    border-bottom: 1px solid var(--border);
    white-space: nowrap; cursor: pointer; user-select: none;
  }
  thead th:hover { color: var(--text); }
  thead th .sort-arrow { margin-left: 4px; opacity: 0.4; }
  thead th.sort-asc .sort-arrow::after  { content: ' â†‘'; opacity: 1; }
  thead th.sort-desc .sort-arrow::after { content: ' â†“'; opacity: 1; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: #0f1828; }
  tbody td { padding: 9px 14px; color: var(--text); white-space: nowrap; }

  /* Bar type badges */
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 0.72rem; font-weight: 600; letter-spacing: 0.06em;
  }
  .badge-mesh      { background: #1a3a1a; color: #4ade80; }
  .badge-shear     { background: #1a2a3a; color: #60a5fa; }
  .badge-loose     { background: #3a2a1a; color: #fb923c; }
  .badge-vs        { background: #2a1a3a; color: #c084fc; }
  .badge-hs        { background: #1a2a3a; color: #22d3ee; }
  .badge-preload   { background: #3a1a1a; color: #f87171; }
  .badge-other     { background: #1e2335; color: #94a3b8; }

  /* â”€â”€ DOWNLOAD BUTTONS â”€â”€ */
  .dl-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
  .dl-btn {
    display: inline-flex; align-items: center; gap: 7px;
    padding: 9px 18px; border-radius: 7px; border: none;
    font-family: 'Rajdhani', sans-serif; font-size: 0.85rem;
    font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    cursor: pointer; transition: all 0.15s;
  }
  .dl-btn.csv  { background: var(--accent); color: #000; }
  .dl-btn.csv:hover { background: #d97706; }
  .dl-btn.xlsx { background: #166534; color: #bbf7d0; border: 1px solid #166534; }
  .dl-btn.xlsx:hover { background: #15803d; }

  /* â”€â”€ FILTER ROW â”€â”€ */
  .filter-row {
    display: flex; gap: 10px; flex-wrap: wrap;
    margin-bottom: 16px; align-items: center;
  }
  .filter-select {
    background: var(--bg2); border: 1px solid var(--border2);
    border-radius: 6px; color: var(--text);
    padding: 7px 12px; font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem; outline: none; cursor: pointer;
  }
  .filter-select:focus { border-color: var(--accent); }

  /* â”€â”€ PAGINATION â”€â”€ */
  .pagination {
    display: flex; align-items: center; gap: 6px;
    padding: 12px 16px; border-top: 1px solid var(--border);
    font-size: 0.8rem; color: var(--muted2);
  }
  .pg-btn {
    background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); border-radius: 5px; padding: 4px 10px;
    cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: border-color 0.15s;
  }
  .pg-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .pg-btn:disabled { opacity: 0.3; cursor: default; }
  .pg-btn.active { background: var(--accent); border-color: var(--accent); color: #000; }
  .pg-info { margin: 0 8px; }

  /* â”€â”€ LOADING OVERLAY â”€â”€ */
  #loading {
    display: none; position: fixed; inset: 0;
    background: rgba(8,12,20,0.85);
    z-index: 100; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
  }
  #loading.show { display: flex; }
  .spinner {
    width: 44px; height: 44px;
    border: 3px solid var(--border2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading p { color: var(--muted2); font-size: 0.9rem; letter-spacing: 0.06em; }

  /* â”€â”€ ANIMATIONS â”€â”€ */
  .fade-in { animation: fadeIn 0.4s ease forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .kpi { animation: fadeIn 0.4s ease forwards; opacity: 0; }
  .kpi:nth-child(1) { animation-delay: 0.05s; }
  .kpi:nth-child(2) { animation-delay: 0.10s; }
  .kpi:nth-child(3) { animation-delay: 0.15s; }
  .kpi:nth-child(4) { animation-delay: 0.20s; }
  .kpi:nth-child(5) { animation-delay: 0.25s; }
  .kpi:nth-child(6) { animation-delay: 0.30s; }
  .kpi:nth-child(7) { animation-delay: 0.35s; }
  .kpi:nth-child(8) { animation-delay: 0.40s; }
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loading">
  <div class="spinner"></div>
  <p id="loading-msg">Processing dataâ€¦</p>
</div>

<div class="shell">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="logo">
      <div class="logo-icon">ğŸ—ï¸</div>
      <div class="logo-text">Cage <span>Rebar</span> Analysis</div>
    </div>
    <div class="topbar-badge">GitHub Pages Â· Client-Side</div>
  </div>

  <!-- UPLOAD ZONE -->
  <div id="upload-zone" onclick="document.getElementById('file-input').click()"
       ondragover="e=>{e.preventDefault();this.classList.add('drag')}"
       ondragleave="this.classList.remove('drag')"
       ondrop="handleDrop(event)">
    <div class="upload-icon">â¬†ï¸</div>
    <h2>Upload Your Data</h2>
    <p>Drop your <strong>CSV</strong> or <strong>Excel</strong> file here<br/>
       or click to browse â€” processed entirely in your browser</p>
    <div class="formats">
      <span class="fmt">CSV</span>
      <span class="fmt">XLSX</span>
      <span class="fmt">XLS</span>
    </div>
    <div id="progress-bar"><div class="bar"></div></div>
  </div>
  <div id="status-msg"></div>
  <input type="file" id="file-input" accept=".csv,.xlsx,.xls" onchange="handleFile(this.files[0])"/>

  <!-- DASHBOARD -->
  <div id="dashboard">

    <!-- File info strip -->
    <div class="file-strip fade-in">
      <div>
        <span class="fname" id="fname"></span>
        <span class="fmeta" id="fmeta"></span>
      </div>
      <button onclick="resetApp()">âœ• Load new file</button>
    </div>

    <!-- KPI CARDS -->
    <div class="kpi-grid" id="kpi-grid"></div>

    <!-- TABS -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('charts',this)">ğŸ“Š Charts</button>
      <button class="tab-btn" onclick="switchTab('cage',this)">ğŸ—ï¸ Cage Summary</button>
      <button class="tab-btn" onclick="switchTab('raw',this)">ğŸ“‹ Raw Data</button>
    </div>

    <!-- â”€â”€ CHARTS TAB â”€â”€ -->
    <div class="tab-panel active" id="tab-charts">
      <div class="chart-grid">
        <div class="chart-box">
          <div class="sec">Bar Type â€” Count</div>
          <canvas id="chart-bar"></canvas>
        </div>
        <div class="chart-box">
          <div class="sec">Bar Type â€” % Share</div>
          <canvas id="chart-pie"></canvas>
        </div>
      </div>
      <div class="chart-box-full">
        <div class="sec">Total Weight by Bar Type</div>
        <canvas id="chart-weight"></canvas>
      </div>
    </div>

    <!-- â”€â”€ CAGE SUMMARY TAB â”€â”€ -->
    <div class="tab-panel" id="tab-cage">
      <div class="sec">Cage Summary</div>
      <div class="table-wrap">
        <div class="table-controls">
          <input class="search-box" id="cage-search" placeholder="ğŸ”  Search cage referenceâ€¦" oninput="filterCage()"/>
          <span class="row-count" id="cage-count"></span>
        </div>
        <div class="tbl-scroll">
          <table id="cage-table">
            <thead>
              <tr>
                <th onclick="sortTable('cage',0)">Cage Reference<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',1)">Total Bars<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',2)">Mesh<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',3)">Non-Mesh<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',4)">Shear Links<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',5)">Mesh+Shear Only<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',6)">Loose Bars<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',7)">VS Bars<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',8)">HS Bars<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',9)">Preload<span class="sort-arrow"></span></th>
                <th onclick="sortTable('cage',10)">LSAP Bars<span class="sort-arrow"></span></th>
              </tr>
            </thead>
            <tbody id="cage-tbody"></tbody>
          </table>
        </div>
        <div class="pagination" id="cage-pagination"></div>
      </div>
      <div class="dl-row">
        <button class="dl-btn csv"  onclick="downloadCSV('cage')">â¬‡ Download CSV</button>
        <button class="dl-btn xlsx" onclick="downloadXLSX('cage')">â¬‡ Download Excel</button>
      </div>
    </div>

    <!-- â”€â”€ RAW DATA TAB â”€â”€ -->
    <div class="tab-panel" id="tab-raw">
      <div class="sec">Raw Data</div>
      <div class="filter-row">
        <input class="search-box" id="raw-search" placeholder="ğŸ”  Search any valueâ€¦" oninput="filterRaw()" style="max-width:260px"/>
        <select class="filter-select" id="raw-bartype" onchange="filterRaw()">
          <option value="">All Bar Types</option>
        </select>
        <span class="row-count" id="raw-count"></span>
      </div>
      <div class="table-wrap">
        <div class="tbl-scroll">
          <table id="raw-table">
            <thead><tr id="raw-thead"></tr></thead>
            <tbody id="raw-tbody"></tbody>
          </table>
        </div>
        <div class="pagination" id="raw-pagination"></div>
      </div>
      <div class="dl-row">
        <button class="dl-btn csv"  onclick="downloadCSV('raw')">â¬‡ Download CSV</button>
        <button class="dl-btn xlsx" onclick="downloadXLSX('raw')">â¬‡ Download Excel</button>
      </div>
    </div>

  </div><!-- /dashboard -->
</div><!-- /shell -->

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allData = [];         // full parsed rows (objects)
let cageSummary = [];     // computed cage summary
let filteredCage = [];
let filteredRaw  = [];
let cagePage = 1, rawPage = 1;
const PAGE = 200;
let cageSortCol = -1, cageSortDir = 1;
let rawSortCol  = -1, rawSortDir  = 1;
let rawCols = [];
let charts = {};

// â”€â”€ COLOUR PALETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = ['#f59e0b','#3b82f6','#22c55e','#ef4444','#a855f7','#06b6d4','#f97316','#ec4899'];

// â”€â”€ BAR TYPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function barType(layer) {
  if (!layer) return 'Other';
  const l = String(layer);
  if (l[0]==='F'||l[0]==='N')            return 'Mesh';
  if (l.slice(0,2)==='LK'||l[0]==='S')   return 'Shear Link';
  if (l.slice(0,2)==='LB')               return 'Loose Bar';
  if (l.slice(0,2)==='VS')               return 'VS Sub-Assembly';
  if (l.slice(0,2)==='HS')               return 'HS Sub-Assembly';
  if (l.slice(0,3)==='PRL')              return 'Preload';
  return 'Other';
}

function badgeClass(bt) {
  const m = {
    'Mesh':'badge-mesh','Shear Link':'badge-shear','Loose Bar':'badge-loose',
    'VS Sub-Assembly':'badge-vs','HS Sub-Assembly':'badge-hs',
    'Preload':'badge-preload','Other':'badge-other'
  };
  return m[bt]||'badge-other';
}

// â”€â”€ DRAG/DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag');
  const f = e.dataTransfer.files[0];
  if (f) handleFile(f);
}

// â”€â”€ FILE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFile(file) {
  if (!file) return;
  setStatus('Reading fileâ€¦');
  showProgress(true);

  const ext = file.name.split('.').pop().toLowerCase();
  const reader = new FileReader();

  reader.onload = e => {
    try {
      if (ext === 'csv') {
        const data = parseCSV(e.target.result);
        processData(data, file.name);
      } else {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, { defval: '' });
        processData(data, file.name);
      }
    } catch(err) {
      setStatus('Error: ' + err.message);
      showProgress(false);
    }
  };

  if (ext === 'csv') reader.readAsText(file);
  else reader.readAsArrayBuffer(file);
}

// â”€â”€ PROCESS DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processData(data, fname) {
  showLoading('Building analysisâ€¦');

  setTimeout(() => {
    try {
      allData = data;

      // Ensure Bar Type column
      if (!allData[0]?.['Bar Type'] && allData[0]?.['Layer']) {
        allData.forEach(r => r['Bar Type'] = barType(r['Layer']));
      }

      rawCols = Object.keys(allData[0] || {});

      // Build cage summary
      buildCageSummary();

      // Show dashboard
      document.getElementById('upload-zone').style.display = 'none';
      document.getElementById('status-msg').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      // File info
      document.getElementById('fname').textContent = fname + '  ';
      document.getElementById('fmeta').textContent =
        `${allData.length.toLocaleString()} rows Â· ${rawCols.length} columns`;

      // Render
      renderKPIs();
      renderCharts();
      renderRawFilters();
      filteredCage = [...cageSummary];
      filteredRaw  = [...allData];
      rawPage = cagePage = 1;
      renderCageTable();
      renderRawTable();

      showLoading(false);
    } catch(err) {
      showLoading(false);
      alert('Error processing data: ' + err.message);
    }
  }, 50);
}

// â”€â”€ CAGE SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCageSummary() {
  const map = {};
  allData.forEach(r => {
    const ref = r['Correct reference'] || r['correct reference'] || r['Cage Ref'] || 'Unknown';
    const bt  = r['Bar Type'] || 'Other';
    if (!map[ref]) map[ref] = { ref, total:0, mesh:0, shear:0, loose:0, vs:0, hs:0, preload:0 };
    map[ref].total++;
    if (bt==='Mesh')             map[ref].mesh++;
    if (bt==='Shear Link')       map[ref].shear++;
    if (bt==='Loose Bar')        map[ref].loose++;
    if (bt==='VS Sub-Assembly')  map[ref].vs++;
    if (bt==='HS Sub-Assembly')  map[ref].hs++;
    if (bt==='Preload')          map[ref].preload++;
  });
  cageSummary = Object.values(map).map(c => ({
    'Cage Reference': c.ref,
    'Total Bars':     c.total,
    'Mesh':           c.mesh,
    'Non-Mesh':       c.total - c.mesh,
    'Shear Links':    c.shear,
    'Mesh+Shear Only':(c.total - c.mesh - c.shear === 0) ? 'Yes' : 'No',
    'Loose Bars':     c.loose,
    'VS Bars':        c.vs,
    'HS Bars':        c.hs,
    'Preload':        c.preload,
    'LSAP Bars':      c.loose + c.vs + c.hs + c.preload,
  }));
}

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIs() {
  const n = allData.length;
  const cages   = cageSummary.length;
  const btCnt   = bt => allData.filter(r=>r['Bar Type']===bt).length;
  const mesh    = btCnt('Mesh');
  const nonmesh = n - mesh;
  const shear   = btCnt('Shear Link');
  const lsap    = btCnt('Loose Bar')+btCnt('VS Sub-Assembly')+btCnt('HS Sub-Assembly')+btCnt('Preload');
  const wt      = allData.reduce((s,r)=>s+(+r['Total Bar Weight']||0),0);
  const avgNM   = cages ? (nonmesh/cages).toFixed(1) : 0;

  const kpis = [
    {label:'Total Cages',   val: cages.toLocaleString(),    sub:'Unique references', cls:'amber'},
    {label:'Total Bars',    val: n.toLocaleString(),         sub:'All bar types',     cls:'blue'},
    {label:'Non-Mesh Bars', val: nonmesh.toLocaleString(),   sub:'Excl. mesh panels', cls:'green'},
    {label:'Total Mesh',    val: mesh.toLocaleString(),      sub:'F & N layer bars',  cls:'red'},
    {label:'Shear Links',   val: shear.toLocaleString(),     sub:'LK & S layer',      cls:'purple'},
    {label:'LSAP Bars',     val: lsap.toLocaleString(),      sub:'LB+VS+HS+PRL',      cls:'cyan'},
    {label:'Avg Non-Mesh',  val: (+avgNM).toLocaleString(),  sub:'Per cage',          cls:'amber'},
    {label:'Total Weight',  val: wt.toLocaleString('en',{maximumFractionDigits:0}), sub:'Sum bar weights', cls:'blue'},
  ];

  document.getElementById('kpi-grid').innerHTML = kpis.map(k=>
    `<div class="kpi ${k.cls}">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-val">${k.val}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`
  ).join('');
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts() {
  const btOrder = ['Mesh','Shear Link','Loose Bar','VS Sub-Assembly','HS Sub-Assembly','Preload','Other'];
  const counts  = btOrder.map(bt => allData.filter(r=>r['Bar Type']===bt).length);
  const weights = btOrder.map(bt =>
    allData.filter(r=>r['Bar Type']===bt).reduce((s,r)=>s+(+r['Total Bar Weight']||0),0)
  );

  // Destroy old
  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  const darkOpts = {
    plugins: { legend: { labels: { color: '#6b7a9a', font: { family: 'DM Sans' } } } },
    scales: {
      x: { ticks: { color:'#6b7a9a' }, grid: { color:'#1c2640' } },
      y: { ticks: { color:'#6b7a9a' }, grid: { color:'#1c2640' } }
    }
  };

  // Bar chart
  charts.bar = new Chart(document.getElementById('chart-bar'), {
    type: 'bar',
    data: {
      labels: btOrder,
      datasets: [{ data: counts, backgroundColor: COLORS, borderRadius: 5, borderSkipped: false }]
    },
    options: { ...darkOpts, indexAxis:'y', plugins: { legend: { display:false } },
      scales: { x: darkOpts.scales.x, y: { ticks:{ color:'#6b7a9a' }, grid:{ color:'#1c2640' } } }
    }
  });

  // Pie chart
  charts.pie = new Chart(document.getElementById('chart-pie'), {
    type: 'doughnut',
    data: { labels: btOrder, datasets: [{ data: counts, backgroundColor: COLORS, borderWidth:2, borderColor:'#0d1220' }] },
    options: { plugins: { legend: { position:'right', labels:{ color:'#6b7a9a', font:{family:'DM Sans'}, boxWidth:12 } } } }
  });

  // Weight chart
  charts.weight = new Chart(document.getElementById('chart-weight'), {
    type: 'bar',
    data: {
      labels: btOrder,
      datasets: [{ data: weights, backgroundColor: COLORS, borderRadius: 5, borderSkipped: false }]
    },
    options: { ...darkOpts, plugins: { legend: { display:false } } }
  });
}

// â”€â”€ RAW TABLE FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRawFilters() {
  const sel = document.getElementById('raw-bartype');
  sel.innerHTML = '<option value="">All Bar Types</option>';
  const types = [...new Set(allData.map(r=>r['Bar Type']).filter(Boolean))].sort();
  types.forEach(t => { const o = document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });

  // Header
  document.getElementById('raw-thead').innerHTML =
    rawCols.map((c,i)=>`<th onclick="sortTable('raw',${i})">${c}<span class="sort-arrow"></span></th>`).join('');
}

// â”€â”€ FILTER FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterCage() {
  const q = document.getElementById('cage-search').value.toLowerCase();
  filteredCage = cageSummary.filter(r =>
    !q || String(r['Cage Reference']).toLowerCase().includes(q)
  );
  cagePage = 1;
  renderCageTable();
}

function filterRaw() {
  const q  = document.getElementById('raw-search').value.toLowerCase();
  const bt = document.getElementById('raw-bartype').value;
  filteredRaw = allData.filter(r => {
    if (bt && r['Bar Type'] !== bt) return false;
    if (q) return Object.values(r).some(v => String(v).toLowerCase().includes(q));
    return true;
  });
  rawPage = 1;
  renderRawTable();
}

// â”€â”€ RENDER CAGE TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCageTable() {
  const cols = ['Cage Reference','Total Bars','Mesh','Non-Mesh','Shear Links','Mesh+Shear Only','Loose Bars','VS Bars','HS Bars','Preload','LSAP Bars'];
  const total = filteredCage.length;
  const pages = Math.ceil(total/PAGE) || 1;
  const slice = filteredCage.slice((cagePage-1)*PAGE, cagePage*PAGE);

  document.getElementById('cage-count').textContent =
    `${total.toLocaleString()} cages`;

  document.getElementById('cage-tbody').innerHTML = slice.map(r =>
    `<tr>${cols.map(c=>`<td>${r[c]??''}</td>`).join('')}</tr>`
  ).join('');

  renderPagination('cage', cagePage, pages, p=>{cagePage=p; renderCageTable();});
}

// â”€â”€ RENDER RAW TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRawTable() {
  const total = filteredRaw.length;
  const pages = Math.ceil(total/PAGE) || 1;
  const slice = filteredRaw.slice((rawPage-1)*PAGE, rawPage*PAGE);

  document.getElementById('raw-count').textContent =
    `${total.toLocaleString()} rows shown`;

  document.getElementById('raw-tbody').innerHTML = slice.map(r =>
    `<tr>${rawCols.map(c => {
      const v = r[c] ?? '';
      if (c === 'Bar Type') return `<td><span class="badge ${badgeClass(v)}">${v}</span></td>`;
      return `<td>${v}</td>`;
    }).join('')}</tr>`
  ).join('');

  renderPagination('raw', rawPage, pages, p=>{rawPage=p; renderRawTable();});
}

// â”€â”€ PAGINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPagination(id, current, total, cb) {
  const el = document.getElementById(`${id}-pagination`);
  if (total <= 1) { el.innerHTML = ''; return; }

  let html = `<span class="pg-info">Page ${current} of ${total}</span>`;
  html += `<button class="pg-btn" onclick="(${cb})(1)" ${current===1?'disabled':''}>Â«</button>`;
  html += `<button class="pg-btn" onclick="(${cb})(${current-1})" ${current===1?'disabled':''}>â€¹</button>`;

  // Show window of pages
  const start = Math.max(1, current-2);
  const end   = Math.min(total, current+2);
  for (let p=start; p<=end; p++) {
    html += `<button class="pg-btn ${p===current?'active':''}" onclick="(${cb})(${p})">${p}</button>`;
  }

  html += `<button class="pg-btn" onclick="(${cb})(${current+1})" ${current===total?'disabled':''}>â€º</button>`;
  html += `<button class="pg-btn" onclick="(${cb})(${total})" ${current===total?'disabled':''}>Â»</button>`;
  el.innerHTML = html;
}

// â”€â”€ SORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sortTable(tbl, col) {
  if (tbl === 'cage') {
    if (cageSortCol === col) cageSortDir *= -1; else { cageSortCol=col; cageSortDir=1; }
    const key = ['Cage Reference','Total Bars','Mesh','Non-Mesh','Shear Links','Mesh+Shear Only','Loose Bars','VS Bars','HS Bars','Preload','LSAP Bars'][col];
    filteredCage.sort((a,b) => {
      const av = isNaN(a[key]) ? String(a[key]) : +a[key];
      const bv = isNaN(b[key]) ? String(b[key]) : +b[key];
      return av < bv ? -cageSortDir : av > bv ? cageSortDir : 0;
    });
    cagePage = 1;
    renderCageTable();
    updateSortHeaders('cage-table', col, cageSortDir);
  } else {
    if (rawSortCol === col) rawSortDir *= -1; else { rawSortCol=col; rawSortDir=1; }
    const key = rawCols[col];
    filteredRaw.sort((a,b) => {
      const av = isNaN(a[key]) ? String(a[key]) : +a[key];
      const bv = isNaN(b[key]) ? String(b[key]) : +b[key];
      return av < bv ? -rawSortDir : av > bv ? rawSortDir : 0;
    });
    rawPage = 1;
    renderRawTable();
    updateSortHeaders('raw-table', col, rawSortDir);
  }
}

function updateSortHeaders(tableId, activeCol, dir) {
  document.querySelectorAll(`#${tableId} thead th`).forEach((th, i) => {
    th.classList.remove('sort-asc','sort-desc');
    if (i === activeCol) th.classList.add(dir===1 ? 'sort-asc' : 'sort-desc');
  });
}

// â”€â”€ DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadCSV(which) {
  const data = which==='cage' ? filteredCage : filteredRaw;
  const csv  = unparseCSV(data);
  const blob = new Blob([csv], {type:'text/csv'});
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = which==='cage' ? 'Cage_Summary.csv' : 'Cage_Analysis_Filtered.csv';
  a.click();
}

function downloadXLSX(which) {
  const data = which==='cage' ? filteredCage : filteredRaw;
  const ws   = XLSX.utils.json_to_sheet(data);
  const wb   = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, which==='cage' ? 'Cage Summary' : 'Raw Data');
  XLSX.writeFile(wb, which==='cage' ? 'Cage_Summary.xlsx' : 'Cage_Analysis_Filtered.xlsx');
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg) { document.getElementById('status-msg').textContent = msg; }
function showProgress(on) { document.getElementById('progress-bar').style.display = on?'block':'none'; }
function showLoading(msg) {
  const el = document.getElementById('loading');
  if (msg) { document.getElementById('loading-msg').textContent = msg; el.classList.add('show'); }
  else el.classList.remove('show');
}
function resetApp() {
  allData=[]; cageSummary=[]; filteredCage=[]; filteredRaw=[];
  Object.values(charts).forEach(c=>c.destroy()); charts={};
  document.getElementById('dashboard').style.display='none';
  document.getElementById('upload-zone').style.display='block';
  document.getElementById('status-msg').style.display='block';
  document.getElementById('file-input').value='';
  setStatus('');
}

// â”€â”€ BUILT-IN CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  if (!lines.length) return [];
  // Parse headers
  const headers = splitCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = splitCSVLine(lines[i]);
    const obj = {};
    headers.forEach((h, idx) => { obj[h] = vals[idx] !== undefined ? vals[idx] : ''; });
    rows.push(obj);
  }
  return rows;
}

function splitCSVLine(line) {
  const result = [];
  let cur = '', inQuote = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuote && line[i+1] === '"') { cur += '"'; i++; }
      else inQuote = !inQuote;
    } else if (ch === ',' && !inQuote) {
      result.push(cur); cur = '';
    } else {
      cur += ch;
    }
  }
  result.push(cur);
  return result;
}

function unparseCSV(data) {
  if (!data.length) return '';
  const headers = Object.keys(data[0]);
  const escape  = v => { const s = String(v??''); return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g,'""') + '"' : s; };
  const rows    = data.map(r => headers.map(h => escape(r[h])).join(','));
  return [headers.join(','), ...rows].join('\n');
}
</script>
</body>
</html>